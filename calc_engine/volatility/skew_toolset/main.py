import matplotlib.pyplot as plt
import numpy as np

class Skew:
    def __init__(self, implied_volatilities: list[float], strikes: list[float]) -> None:
        self._implied_volatilities: list[float] = implied_volatilities
        self._strikes: list[float] = strikes

    def moneyness(self, S: float):

        # try to find a way to get the atm strike so we dont need to pass in S

        filtered_ivs_strikes: list[tuple(float, float)] = [(iv, np.log(strike / S)) for iv, strike in zip(self._implied_volatilities, self._strikes)]# if eval(func)]
        self._implied_volatilities, self._strikes = zip(*filtered_ivs_strikes)

        return list(self._implied_volatilities), list(self._strikes)

    
    def filter(self, func: str) -> (list[float], list[float]):

        filtered_ivs_strikes: list[tuple(float, float)] = [(iv, strike) for iv, strike in zip(self._implied_volatilities, self._strikes) if eval(func)]
        self._implied_volatilities, self._strikes = zip(*filtered_ivs_strikes)

        return list(self._implied_volatilities), list(self._strikes)

    
def plot_skew(skew_structure: Skew, func: str = "iv > .02"):

    ivs1, strikes1 = skew_structure.filter(func)

    print(func)
    print(len(strikes1))

    plt.plot(strikes1, ivs1, '.')
    plt.show()
    return None

def main():


    call_strikes = [3300.0, 3320.0, 3400.0, 3500.0, 3700.0, 3800.0, 3850.0, 3900.0, 3990.0, 4000.0, 4005.0, 4015.0, 4050.0, 4055.0, 4100.0, 4150.0, 4190.0, 4200.0, 4205.0, 4220.0, 4250.0, 4290.0, 4295.0, 4300.0, 4305.0, 4310.0, 4315.0, 4320.0, 4345.0, 4350.0, 4360.0, 4365.0, 4370.0, 4380.0, 4385.0, 4390.0, 4400.0, 4405.0, 4420.0, 4425.0, 4435.0, 4440.0, 4450.0, 4455.0, 4460.0, 4465.0, 4470.0, 4475.0, 4480.0, 4490.0, 4495.0, 4500.0, 4505.0, 4510.0, 4515.0, 4520.0, 4525.0, 4530.0, 4535.0, 4540.0, 4550.0, 4560.0, 4570.0, 4575.0, 4580.0, 4585.0, 4595.0, 4600.0, 4605.0, 4610.0, 4615.0, 4620.0, 4625.0, 4630.0, 4635.0, 4640.0, 4645.0, 4650.0, 4655.0, 4660.0, 4665.0, 4670.0, 4675.0, 4680.0, 4685.0, 4690.0, 4695.0, 4700.0, 4705.0, 4710.0, 4715.0, 4720.0, 4725.0, 4730.0, 4735.0, 4740.0, 4745.0, 4750.0, 4755.0, 4760.0, 4765.0, 4770.0, 4775.0, 4780.0, 4785.0, 4790.0, 4795.0, 4800.0, 4805.0, 4810.0, 4815.0, 4820.0, 4825.0, 4830.0, 4835.0, 4840.0, 4845.0, 4850.0, 4855.0, 4860.0, 4865.0, 4870.0, 4875.0, 4880.0, 4885.0, 4890.0, 4895.0, 4900.0, 4905.0, 4910.0, 4915.0, 4920.0, 4925.0, 4930.0, 4935.0, 4940.0, 4945.0, 4950.0, 4955.0, 4960.0, 4965.0, 4970.0, 4975.0, 4980.0, 4985.0, 4990.0, 4995.0, 5000.0, 5005.0, 5010.0, 5015.0, 5020.0, 5025.0, 5030.0, 5035.0, 5040.0, 5045.0, 5050.0, 5055.0, 5060.0, 5065.0, 5070.0, 5075.0, 5080.0, 5085.0, 5090.0, 5095.0, 5100.0, 5105.0, 5110.0, 5115.0, 5120.0, 5125.0, 5130.0, 5135.0, 5140.0, 5145.0, 5150.0, 5155.0, 5160.0, 5165.0, 5170.0, 5175.0, 5180.0, 5185.0, 5190.0, 5200.0, 5210.0, 5220.0, 5225.0, 5230.0, 5240.0, 5250.0, 5260.0, 5270.0, 5275.0, 5280.0, 5290.0, 5300.0, 5310.0, 5320.0, 5325.0, 5330.0, 5340.0, 5350.0, 5375.0, 5400.0, 5425.0, 5450.0, 5500.0, 5550.0, 5600.0, 5650.0, 5700.0, 5750.0, 5800.0, 5900.0, 6000.0, 6200.0]
    call_ivs = [0.5861247442626953, 0.580204393310547, 0.5560957476806643, 0.5269822692871093, 0.5140582041931152, 0.48042816940307614, 0.46442948905944825, 0.4480111962127685, 0.4195195072555542, 0.41580021461486816, 0.41428960960388184, 0.41057794628143307, 0.4002669226837159, 0.3987410590362549, 0.38397069892883307, 0.3675981819915771, 0.35542179008483876, 0.3522861402893066, 0.22914894393920898, 0.22791299438476562, 0.3367604776763916, 0.3242369517898559, 0.32262716564178456, 0.31915964050292955, 0.31940377868652337, 0.2165147929382324, 0.31642834457397456, 0.3148071144485473, 0.3069183993911743, 0.3040230731201171, 0.3027489769744873, 0.30134899707794194, 0.29945311149597165, 0.2966302637481689, 0.29473056350708, 0.29355183383941647, 0.29022163642883303, 0.2887873246002197, 0.28445387184143056, 0.28277160717010497, 0.27074398696899415, 0.2596814755249024, 0.26624650386810306, 0.2648160066986084, 0.2633816948699951, 0.2619397537231446, 0.2516592473983765, 0.25903679813385017, 0.2578046632385254, 0.2548673757171631, 0.25339110263824466, 0.2519072002410888, 0.2506369187545776, 0.2491415723800659, 0.24785603225708008, 0.24634542724609376, 0.2448310075759888, 0.2435187648391724, 0.24199290119171146, 0.2406653998184204, 0.23778533218383785, 0.23507310955047606, 0.232330369644165, 0.23074347145080568, 0.22954948314666745, 0.22814568859100343, 0.08701474517822266, 0.21723194885253905, 0.22263732082366938, 0.22118775035858151, 0.21972673591613767, 0.21844882511138913, 0.21696873737335204, 0.21566793861389158, 0.2143518812179565, 0.2104494849395752, 0.20912961288452142, 0.20779829685211182, 0.20645172218322747, 0.2052729925155639, 0.20390352989196778, 0.20252262329101559, 0.20130193237304686, 0.2000659828186035, 0.19864311496734616, 0.1973804627990723, 0.19610255199432375, 0.19036911933898928, 0.1934971398162842, 0.19234129810333256, 0.19099853809356693, 0.18964433410644532, 0.18843508716583252, 0.1872086742591858, 0.18596318805694578, 0.18470053588867186, 0.18342262508392332, 0.1779905504989624, 0.18096216995239256, 0.17977962562561037, 0.17857800800323487, 0.17735731708526614, 0.17611373821258547, 0.17499985774993898, 0.17371431762695314, 0.17255466125488284, 0.1713721169281006, 0.16631387893676763, 0.16908522878646853, 0.16826889173507695, 0.1669890736007691, 0.1659705596160889, 0.1644942865371704, 0.16370846675872808, 0.16246679521560672, 0.16119842105865478, 0.16032104946136472, 0.15537343658447267, 0.15819246967315675, 0.15708431119918823, 0.15607914852142335, 0.15490614084243778, 0.1539715493583679, 0.15286720554351813, 0.1518639501953125, 0.15082254825592045, 0.1498803274536133, 0.1453179951477051, 0.1478852607345581, 0.1469602058982849, 0.14599700447082517, 0.14512535486221317, 0.14421174400329587, 0.1432561718940735, 0.14238833694458009, 0.14147663341522215, 0.14065266704559326, 0.1365500011634827, 0.13899329032897953, 0.13816169464111328, 0.1352167778015137, 0.1344156993865967, 0.1326628635215759, 0.132020093460083, 0.13236341278076175, 0.1316195542526245, 0.13095198890686036, 0.12931931480407713, 0.12971985401153563, 0.12902177139282228, 0.12734713603973385, 0.12785639303207397, 0.1261912943267822, 0.12673106859207153, 0.1261512404060364, 0.12578312580108647, 0.12522237091064453, 0.12363928737640381, 0.12405889987945558, 0.1237346538543701, 0.12335318794250491, 0.12291259481430053, 0.12140771179199218, 0.12213821901321412, 0.12166138662338255, 0.1214172484397888, 0.12096521133422852, 0.1196892078590393, 0.12033007059097289, 0.12000010257720946, 0.11976359371185301, 0.11946986495971679, 0.11813473426818846, 0.11886333415985105, 0.11854862478256226, 0.118172880859375, 0.11807751438140869, 0.11685873079299927, 0.11753583278656006, 0.11744428096771241, 0.11711240562438965, 0.11690259937286375, 0.11604811573028563, 0.11670042243957521, 0.116307512550354, 0.11626173664093019, 0.11512496822357178, 0.11572386970520021, 0.11544539958953857, 0.11472061435699464, 0.11517074413299562, 0.11518218811035157, 0.11497619651794433, 0.11482361015319825, 0.11474731697082521, 0.11479309288024903, 0.11478546356201172, 0.11460617458343507, 0.11419037673950197, 0.11470154106140137, 0.11464050651550295, 0.11496856719970702, 0.11480835151672364, 0.11478546356201172, 0.1145489546966553, 0.11557891265869141, 0.1155483953857422, 0.11710477630615235, 0.11838650177001953, 0.12156029815673827, 0.12522237091064453, 0.1287928918457031, 0.1331873791503906, 0.13794807373046875, 0.1437463555908203, 0.14905636108398437, 0.15821154296875, 0.1682212084960938, 0.19409985595703128]

    put_strikes = [3275.0, 3300.0, 3310.0, 3320.0, 3325.0, 3330.0, 3340.0, 3350.0, 3360.0, 3370.0, 3375.0, 3380.0, 3390.0, 3400.0, 3410.0, 3420.0, 3425.0, 3430.0, 3440.0, 3450.0, 3460.0, 3470.0, 3475.0, 3480.0, 3490.0, 3500.0, 3510.0, 3520.0, 3525.0, 3530.0, 3540.0, 3550.0, 3560.0, 3570.0, 3575.0, 3580.0, 3590.0, 3600.0, 3610.0, 3620.0, 3625.0, 3630.0, 3640.0, 3645.0, 3650.0, 3655.0, 3660.0, 3665.0, 3670.0, 3675.0, 3680.0, 3685.0, 3690.0, 3695.0, 3700.0, 3705.0, 3710.0, 3715.0, 3720.0, 3725.0, 3730.0, 3735.0, 3740.0, 3745.0, 3750.0, 3755.0, 3760.0, 3765.0, 3770.0, 3775.0, 3780.0, 3785.0, 3790.0, 3795.0, 3800.0, 3805.0, 3810.0, 3815.0, 3820.0, 3825.0, 3830.0, 3835.0, 3840.0, 3845.0, 3850.0, 3855.0, 3860.0, 3865.0, 3870.0, 3875.0, 3880.0, 3885.0, 3890.0, 3895.0, 3900.0, 3905.0, 3910.0, 3915.0, 3920.0, 3925.0, 3930.0, 3935.0, 3940.0, 3945.0, 3950.0, 3955.0, 3960.0, 3965.0, 3970.0, 3975.0, 3980.0, 3985.0, 3990.0, 3995.0, 4000.0, 4005.0, 4010.0, 4015.0, 4020.0, 4025.0, 4030.0, 4035.0, 4040.0, 4045.0, 4050.0, 4055.0, 4060.0, 4065.0, 4070.0, 4075.0, 4080.0, 4085.0, 4090.0, 4095.0, 4100.0, 4105.0, 4110.0, 4115.0, 4120.0, 4125.0, 4130.0, 4135.0, 4140.0, 4145.0, 4150.0, 4155.0, 4160.0, 4165.0, 4170.0, 4175.0, 4180.0, 4185.0, 4190.0, 4195.0, 4200.0, 4205.0, 4210.0, 4215.0, 4220.0, 4225.0, 4230.0, 4235.0, 4240.0, 4245.0, 4250.0, 4255.0, 4260.0, 4265.0, 4270.0, 4275.0, 4280.0, 4285.0, 4290.0, 4295.0, 4300.0, 4305.0, 4310.0, 4315.0, 4320.0, 4325.0, 4330.0, 4335.0, 4340.0, 4345.0, 4350.0, 4355.0, 4360.0, 4365.0, 4370.0, 4375.0, 4380.0, 4385.0, 4390.0, 4395.0, 4400.0, 4405.0, 4410.0, 4415.0, 4420.0, 4425.0, 4430.0, 4435.0, 4440.0, 4445.0, 4450.0, 4455.0, 4460.0, 4465.0, 4470.0, 4475.0, 4480.0, 4485.0, 4490.0, 4495.0, 4500.0, 4505.0, 4510.0, 4515.0, 4520.0, 4525.0, 4530.0, 4535.0, 4540.0, 4545.0, 4550.0, 4555.0, 4560.0, 4565.0, 4570.0, 4575.0, 4580.0, 4585.0, 4590.0, 4595.0, 4600.0, 4605.0, 4610.0, 4615.0, 4620.0, 4625.0, 4630.0, 4635.0, 4640.0, 4645.0, 4650.0, 4655.0, 4660.0, 4665.0, 4670.0, 4675.0, 4680.0, 4685.0, 4690.0, 4695.0, 4700.0, 4705.0, 4710.0, 4715.0, 4720.0, 4725.0, 4730.0, 4735.0, 4740.0, 4745.0, 4750.0, 4755.0, 4760.0, 4765.0, 4770.0, 4775.0, 4780.0, 4785.0, 4790.0, 4795.0, 4800.0, 4805.0, 4810.0, 4815.0, 4820.0, 4825.0, 4830.0, 4835.0, 4840.0, 4845.0, 4850.0, 4855.0, 4860.0, 4865.0, 4870.0, 4875.0, 4880.0, 4885.0, 4890.0, 4895.0, 4900.0, 4905.0, 4910.0, 4915.0, 4920.0, 4925.0, 4930.0, 4935.0, 4940.0, 4945.0, 4950.0, 4955.0, 4960.0, 4965.0, 4970.0, 4975.0, 4980.0, 4985.0, 4990.0, 4995.0, 5000.0, 5005.0, 5010.0, 5020.0, 5025.0, 5030.0, 5035.0, 5040.0, 5045.0, 5050.0, 5060.0, 5070.0, 5075.0, 5090.0, 5100.0, 5115.0, 5120.0, 5125.0, 5130.0, 5140.0, 5190.0, 5290.0, 5310.0, 5350.0, 5450.0, 5800.0, 5900.0]
    put_ivs = [0.4309749285888672, 0.42377285217285154, 0.42249112670898437, 0.4212094012451172, 0.41974457214355465, 0.41834077758789057, 0.41547215393066406, 0.4141293939208984, 0.4112607702636719, 0.40985697570800783, 0.40845318115234375, 0.40704938659667966, 0.4055845574951171, 0.40277696838378907, 0.4012511047363281, 0.398443515625, 0.3983214465332031, 0.39691765197753903, 0.394110062866211, 0.39258419921875, 0.3897460928344727, 0.3881897119140625, 0.3867554000854492, 0.3865417791748046, 0.38373419006347653, 0.38092660095214836, 0.3793091854858398, 0.3776307354736328, 0.37622694091796877, 0.37485366363525385, 0.37317521362304684, 0.37036762451171873, 0.36865865722656255, 0.3669191726684571, 0.365515378112793, 0.3651491708374024, 0.36237209899902345, 0.3595950271606445, 0.3587710607910156, 0.3560245062255859, 0.3555667471313476, 0.35419346984863276, 0.3523624334716796, 0.35095863891601553, 0.348639326171875, 0.34909708526611327, 0.3477238079833984, 0.3472355316162109, 0.3458317370605468, 0.34445845977783207, 0.3465031170654296, 0.34256638885498036, 0.34204759521484374, 0.34064380065917965, 0.3384160397338867, 0.33872121246337883, 0.3373479351806641, 0.3367986242675781, 0.33539482971191403, 0.3340215524291992, 0.3334417242431641, 0.33206844696044924, 0.33148861877441405, 0.33008482421874996, 0.3287115469360351, 0.3281012014770508, 0.32672792419433594, 0.32688051055908207, 0.3254767160034179, 0.324103438720703, 0.32273016143798816, 0.32282171325683584, 0.32141791870117187, 0.320044641418457, 0.31867136413574215, 0.3187018814086914, 0.3173286041259765, 0.31592480957031244, 0.3145515322875976, 0.3145515322875976, 0.3131629963684082, 0.3117744604492187, 0.3104011831665039, 0.34992105163574216, 0.3076546286010742, 0.3075935940551757, 0.30620505813598636, 0.30609824768066407, 0.3047249703979492, 0.30335169311523436, 0.30321436538696284, 0.3018258294677735, 0.3004525521850586, 0.2990792749023437, 0.2976907389831542, 0.29752289398193354, 0.29611909942626957, 0.2959207371520996, 0.29453220123291013, 0.29315892395019527, 0.29291478576660146, 0.2915415084838866, 0.29015297256469724, 0.2898783171081542, 0.2873911593627929, 0.29537142623901363, 0.2868113311767577, 0.2854227952575683, 0.2840342593383788, 0.2836985693359374, 0.28232529205322265, 0.2809367561340332, 0.28057054885864247, 0.2791820129394531, 0.27780873565673825, 0.2774120111083984, 0.27602347518920894, 0.2746349392700196, 0.274222956085205, 0.2718731260681152, 0.2724071783447265, 0.27101864242553714, 0.27056088333129885, 0.2691723474121094, 0.2668530346679688, 0.2672955351257324, 0.2659069992065429, 0.26540346420288086, 0.26399966964721683, 0.2634808760070801, 0.2620923400878906, 0.26068854553222653, 0.26015449325561524, 0.2587506986999512, 0.2573469041442871, 0.25679759323120116, 0.256217765045166, 0.254813970489502, 0.2542188836669922, 0.2528150891113281, 0.25220474365234374, 0.250785690460205, 0.25016008636474607, 0.27017941741943363, 0.24735249725341796, 0.2474440490722656, 0.24604025451660155, 0.24536887451171874, 0.2439498213195801, 0.24326318267822267, 0.2425612854003906, 0.24114223220825193, 0.24042507629394527, 0.239692661743164, 0.23758696990966793, 0.23752593536376948, 0.23610688217163084, 0.2353439503479004, 0.2345810185241699, 0.2338028280639648, 0.23236851623535154, 0.23157506713867188, 0.2307816180419922, 0.2293473062133789, 0.22791299438476562, 0.22769937347412106, 0.22686014846801755, 0.22602092346191405, 0.22457135299682612, 0.223716869354248, 0.22285475639343258, 0.22197738479614254, 0.2210923838806152, 0.22019975364685054, 0.2181932429504394, 0.21838397590637204, 0.2174608283996582, 0.2165376808929443, 0.21507285179138183, 0.21413444564819334, 0.2131884101867676, 0.21222711608886718, 0.21126582199096677, 0.21079280426025387, 0.20882444015502927, 0.20881681083679196, 0.20781737014770507, 0.20681030014038082, 0.20579560081481932, 0.20477327217102045, 0.20374331420898437, 0.2031634860229492, 0.20211064010620117, 0.2010577941894531, 0.19955481849670412, 0.19935645622253417, 0.1982807223510742, 0.19718972984313962, 0.1965183498382568, 0.19541209869384768, 0.1947102014160156, 0.19358869163513184, 0.19285627708435057, 0.19171950866699222, 0.19017838638305667, 0.18980454978942876, 0.18902635932922365, 0.18822528091430663, 0.18705036590576174, 0.1862263995361328, 0.1853948038482666, 0.18454032020568847, 0.183327258605957, 0.18245751632690427, 0.18122538143157957, 0.180672255859375, 0.179421047668457, 0.17883359016418457, 0.17789518402099608, 0.176941519241333, 0.17565979377746582, 0.1753164744567871, 0.17432466308593753, 0.17332140773773191, 0.1719977210235596, 0.1715781085205078, 0.1705328919219971, 0.16976996009826664, 0.16869804088592533, 0.16790077713012697, 0.16708444007873538, 0.16625284439086918, 0.16512370529174808, 0.16426159233093263, 0.16284253913879396, 0.16247633186340332, 0.16155699901580806, 0.1606224075317383, 0.15966874275207518, 0.157948331489563, 0.15796740478515625, 0.15647205841064454, 0.15618214431762695, 0.15514455703735353, 0.1536186933898926, 0.15348136566162113, 0.15239037315368656, 0.15151300155639652, 0.15060892734527592, 0.149247094039917, 0.14896099460601808, 0.14799588584899906, 0.14701170379638673, 0.14600463378906248, 0.14477249889373778, 0.14434144241333008, 0.143475514793396, 0.14258288455963136, 0.14166355171203612, 0.14091969318389896, 0.13995076976776122, 0.1389627730560303, 0.1381349920272827, 0.13728050838470462, 0.13585001121520998, 0.13548761859893804, 0.1345530271148682, 0.13376339267730714, 0.13294324096679688, 0.13157759300231933, 0.13104354072570798, 0.1303034968566894, 0.1293612760543823, 0.12855256832122802, 0.127225066947937, 0.12683597171783445, 0.1259280828475952, 0.12514226306915283, 0.12431829669952395, 0.12345999839782715, 0.12256546083450318, 0.12178345571517943, 0.12081262496948242, 0.12010309837341307, 0.11861919597625732, 0.11840938972473145, 0.11757016471862794, 0.11683393550872802, 0.11605193038940428, 0.11522605669021607, 0.11421707935333252, 0.11343888889312743, 0.11261301519393921, 0.11187487865447997, 0.11027844381332397, 0.11038334693908691, 0.10949453136444091, 0.10868582363128663, 0.10782561800003052, 0.10704170555114745, 0.10620248054504394, 0.10543573406219482, 0.10474146610260009, 0.10385646518707274, 0.10226765966415402, 0.10216657119750974, 0.10135595613479614, 0.1007398886871338, 0.09979766788482666, 0.09904618003845214, 0.0982260283279419, 0.09746500383377077, 0.09663150081634522, 0.09572361194610597, 0.09407949386596678, 0.09406804988861084, 0.09318686363220216, 0.09361792011260987, 0.09277297311782837, 0.0919795240211487, 0.09109833776474, 0.09026483474731445, 0.08933787258148194, 0.08845668632507325, 0.08653409812927246, 0.08447036754608157, 0.08349762947082523, 0.11133319705963134, 0.0772377738571167, 0.11039860557556153, 0.2072108393478393, 0.06863190288543704, 0.1558350103378296, 0.060113769073486326, 0.1662757323455811, 0.20196568305969237, 0.2253266555023193, 0.11554076606750491, 0.19409985595703128, 0.501893256263733, 0.8629736297988893]

    call_func: str = "iv > .02 and iv < .9 and strike > 4930"
    put_func: str = "iv > .02 and iv < .9 and strike < 4930"

    call_skew = Skew(call_ivs, call_strikes)

    put_skew = Skew(put_ivs, put_strikes)

    call_ivs_new, call_strikes_new = call_skew.filter(call_func)
    put_ivs_new, put_strikes_new = put_skew.filter(put_func)

    iv_list = put_ivs_new + call_ivs_new
    strike_list = put_strikes_new + call_strikes_new
    print(len(iv_list))
    print(len(strike_list))

    plt.plot(strike_list, iv_list, '.')
    plt.show()

    return strike_list

if __name__ == "__main__":
    print(main())